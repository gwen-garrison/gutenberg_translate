{% extends 'base.html' %}

{% block body %}
    <h1>Translation Page</h1>

    <div id="user_controls">
        <h3>{{ book_obj.name }} by {{ book_obj.author }} in {{ language }}</h3>
        <form action="/rendertranslations" method="GET">
            <label>Chapter:
                <select name="chapter_selection">
                    {% for chapter_number in range(1, number_of_chapters) %}
                    {% if chapter_number == chapter_chosen %}
                    <option value="{{ chapter_number|string() }}" selected="selected">Chapter {{ chapter_number }}</option>
                    {% else %}
                    <option value="{{ chapter_number|string() }}">Chapter {{ chapter_number }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </label>
            <input type="hidden" value="{{ bookgroup_id }}" name="bookgroup_id_input">
            <input type="hidden" value="{{ book_id }}" name="hidden_bookid_input">
            <input type="hidden" value="{{ language }}" name="hidden_lang_input">
            <input type="hidden" value="{{ group_id }}" name="hidden_groupid_input">
            <input id="chosen_chap_submit" type="submit">
        </form>
    </div>

    <div class="book-info">
        <div class="row">
            <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                {% if chapter_chosen %}
                <h2>Chapter {{ chapter_chosen }}</h2>
                {% else %}
                <h2>Chapter 1</h2>
                {% endif %}
            </div>
            <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                <h2>Translations</h2>
            </div>
        </div>
    </div>


    <div id="wrapper">
        <form name="text_form" method="POST" action="/save_text"
            id="translate_textarea" data-bookgroupid = "{{ bookgroup_id }}"
            class="col-xs-6 col-sm-6 col-md-6 col-lg-6 col-xs-offset-6 col-md-offset-6 col-lg-offset-6">
            <label>Translate :<br>
                <textarea name="translated_text" id="text_form_ta"
                placeholder="Enter text here!" required></textarea>
            </label><br>
            <input type="hidden" name="hidden_book_id_input" value="{{ book_id }}">
            <!-- <button>Delete</button> -->
            <input type="button" value="submit" id="submit_bttn">

        </form>
        {%  for paragraph in display_chapter %}
        <div class="book_rendering row">
            <div class="untranslated col-xs-6 col-sm-6 col-md-6 col-lg-6">
                <div class="a_chapter_and_bttn {{ paragraph.paragraph_id }}">
                    <p>{{ paragraph.untranslated_paragraph }}</p>
                    <button class="edit_text" data-paragraphid="{{ paragraph.paragraph_id }}"> Edit
                    </button> 
                </div>
            </div>

            <div class="trans_para col-xs-6 col-sm-6 col-md-6 col-lg-6" id="{{ paragraph.paragraph_id }}">
                {% if display_translations %}
                    {% for existing_translation in display_translations %}
                        {% if existing_translation.paragraph_id == paragraph.paragraph_id %}
                            <p>{{ existing_translation.translated_paragraph }}</p>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        {% endfor %}

    </div>


<script type="text/javascript">
    $(document).ready(function(){
        // add logic about what happens if edit button is already clicked
        var langId = $("#translated").data('language');
        var groupId = $("#translated").data('groupid');
        var bookId = $("#translated").data('bookid');
        var bookgroupId = $("#translate_textarea").data('bookgroupid');
        var counter = 0;

        var paragraphId;
        var socket = io.connect('http://' + document.domain + ':' + location.port + '/rendertranslations');

        socket.on('connect', function () {
            var chapterNumber = $("select[name=chapter_selection] option:selected").val();
            socket.emit("joined", {"bookgroup_id": bookgroupId, "chapter_number": chapterNumber});
        });

        socket.on('joined_status', function (data) {
            console.log(data.msg);
        });

        socket.on('my response', function () {
            alert("my response");
        });

        socket.on('update text', function (msg) {
            console.log(msg);
            $('#id' + msg.paragraphId +" p").val(msg.change_text);
        });

        $(".edit_text").click(function () {
            // stop the deletion of text when another edit button is clicked
            // show the edited text in the textarea
            paragraphId = $(this).data('paragraphid');
            var translated_para = $("#" + paragraphId);
            var translated_para_text =  $("#" + paragraphId + " p").text();

            $(".trans_para").hide();
            $("#translate_textarea").show();
            console.log(paragraphId);
            console.log(translated_para_text);
            // debugger;
            socket.emit('value changed', {"paragraphId" : paragraphId, "change_text": translated_para_text});
            console.log("Yeah boy");
        });

        function placeParagraph(translatedText, pId) {
            // Places the translated text in the assigned paragraph div depending on
            // whether a user adds or updates a translation. Doesn't make a db call.
            // change name
            var paragraphId = $("#"+pId);

            paragraphId.empty();
            paragraphId.html("<p>"+translatedText+"</p>");
        }

        // hides and shows edit button
        $(".a_chapter_and_bttn").on("mouseenter", function () {
            $(this).find("button").show();
        });

        $(".a_chapter_and_bttn").on("mouseleave", function () {
            $(this).find("button").hide();
        });

        $("#submit_bttn").on("click", function (evt) {
            evt.preventDefault();
            var translated_text = $("#text_form_ta").val();

            $.ajax({
                url: "/save_text",
                data: $('form').serialize() + "&p_id=" + paragraphId + "&bg_id=" + bookgroupId,
                type: "POST",
                success: function(response) {
                    $("#translate_textarea").hide();
                    placeParagraph(response.translated_text, response.paragraph_id);
                },
                error: function(error) {
                    console.log(error);
                }
            });
            $(".trans_para").show();
        });

        function main() {
            // hide the edit text button
            var edit_text_bttn = $(".edit_text");
            edit_text_bttn.hide();

            $("#translate_textarea").hide();
        }

        main();
    });
</script>
{% endblock %}